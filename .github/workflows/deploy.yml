name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            cd /srv/spk-waspas

            # Pull latest code
            git pull origin main

            # Decode and create .env files
            echo "${{ secrets.ENV_BASE64 }}" | base64 -d > .env
            echo "${{ secrets.ENV_DB_BASE64 }}" | base64 -d > .env.db

            # Build and restart containers
            docker compose down
            docker compose build --no-cache
            RUN_MIGRATIONS=false docker compose up -d

            # Wait for containers to be healthy
            echo "Waiting for containers..."
            sleep 15

            # Put app in maintenance mode
            docker compose exec -T app php artisan down --message="Deploy in progress" --retry=60 || true

            # Run migrations
            docker compose exec -T app php artisan migrate --force

            # Clear and cache
            docker compose exec -T app php artisan route:cache
            docker compose exec -T app php artisan view:cache

            # Bring app back online
            docker compose exec -T app php artisan up

            echo "Deployment completed successfully!"
