name: Validate Deployment Secrets

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets exist
        run: |
          echo "Checking if all required secrets are configured..."

          MISSING_SECRETS=""

          # Check VPS connection secrets
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}VPS_HOST, "
          fi

          if [ -z "${{ secrets.VPS_USERNAME }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}VPS_USERNAME, "
          fi

          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}VPS_SSH_KEY, "
          fi

          # Check environment secrets
          if [ -z "${{ secrets.ENV_BASE64 }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}ENV_BASE64, "
          fi

          if [ -z "${{ secrets.ENV_DB_BASE64 }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}ENV_DB_BASE64, "
          fi

          # Report results
          if [ -n "$MISSING_SECRETS" ]; then
            echo "‚ùå Missing required secrets: ${MISSING_SECRETS%, }"
            exit 1
          fi

          echo "‚úÖ All required secrets are configured"

      - name: Validate base64 encoded secrets
        run: |
          echo "Validating base64 encoding of environment secrets..."

          # Test ENV_BASE64 decoding
          if echo "${{ secrets.ENV_BASE64 }}" | base64 -d > /tmp/test_env 2>/dev/null; then
            if grep -q "APP_KEY" /tmp/test_env && grep -q "DB_" /tmp/test_env; then
              echo "‚úÖ ENV_BASE64 is valid and contains expected variables"
            else
              echo "‚ö†Ô∏è  ENV_BASE64 decoded but missing expected variables (APP_KEY, DB_*)"
              exit 1
            fi
          else
            echo "‚ùå ENV_BASE64 is not valid base64"
            exit 1
          fi

          # Test ENV_DB_BASE64 decoding
          if echo "${{ secrets.ENV_DB_BASE64 }}" | base64 -d > /tmp/test_env_db 2>/dev/null; then
            if grep -q "MYSQL_" /tmp/test_env_db; then
              echo "‚úÖ ENV_DB_BASE64 is valid and contains expected variables"
            else
              echo "‚ö†Ô∏è  ENV_DB_BASE64 decoded but missing expected variables (MYSQL_*)"
              exit 1
            fi
          else
            echo "‚ùå ENV_DB_BASE64 is not valid base64"
            exit 1
          fi

          # Cleanup
          rm -f /tmp/test_env /tmp/test_env_db

          echo "‚úÖ All base64 secrets are valid"

      - name: Validate SSH key format
        run: |
          echo "Validating SSH key format..."

          # Save SSH key to file
          echo "${{ secrets.VPS_SSH_KEY }}" > /tmp/test_key
          chmod 600 /tmp/test_key

          # Check if it's a valid SSH private key
          if ssh-keygen -y -f /tmp/test_key > /dev/null 2>&1; then
            echo "‚úÖ VPS_SSH_KEY is a valid SSH private key"
          else
            echo "‚ùå VPS_SSH_KEY is not a valid SSH private key"
            rm -f /tmp/test_key
            exit 1
          fi

          # Get key type
          KEY_TYPE=$(ssh-keygen -l -f /tmp/test_key 2>/dev/null | awk '{print $NF}' | tr -d '()')
          echo "   Key type: $KEY_TYPE"

          # Cleanup
          rm -f /tmp/test_key

          echo "‚úÖ SSH key validation passed"

      - name: Validate VPS connectivity
        run: |
          echo "Testing SSH connectivity to VPS..."

          # Save SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Configure SSH
          cat >> ~/.ssh/config << EOF
          Host vps
            HostName ${{ secrets.VPS_HOST }}
            User ${{ secrets.VPS_USERNAME }}
            Port ${{ secrets.VPS_PORT || 22 }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            ConnectTimeout 10
          EOF

          # Test connection
          if ssh vps "echo 'SSH connection successful' && docker --version && docker compose version" 2>/dev/null; then
            echo "‚úÖ SSH connection successful"
            echo "‚úÖ Docker is installed on VPS"
            echo "‚úÖ Docker Compose is installed on VPS"
          else
            echo "‚ùå Failed to connect to VPS or Docker not installed"
            echo "   Please check:"
            echo "   - VPS_HOST is correct and accessible"
            echo "   - VPS_USERNAME has SSH access"
            echo "   - VPS_SSH_KEY is authorized on the VPS"
            echo "   - VPS_PORT (if set) is correct"
            echo "   - Docker and Docker Compose are installed on VPS"
            exit 1
          fi

          # Check if deployment directory exists
          if ssh vps "test -d /srv/spk-waspas" 2>/dev/null; then
            echo "‚úÖ Deployment directory /srv/spk-waspas exists"
          else
            echo "‚ö†Ô∏è  Deployment directory /srv/spk-waspas does not exist"
            echo "   Run: mkdir -p /srv/spk-waspas && cd /srv/spk-waspas && git clone <repo-url> ."
          fi

          echo "‚úÖ VPS connectivity validation passed"

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo "‚úÖ ALL DEPLOYMENT SECRETS ARE VALID"
          echo "=========================================="
          echo ""
          echo "Validated secrets:"
          echo "  ‚úÖ VPS_HOST"
          echo "  ‚úÖ VPS_USERNAME"
          echo "  ‚úÖ VPS_SSH_KEY (valid SSH key)"
          echo "  ‚úÖ VPS_PORT (${VPS_PORT:-22 (default)})"
          echo "  ‚úÖ ENV_BASE64 (valid base64, contains required vars)"
          echo "  ‚úÖ ENV_DB_BASE64 (valid base64, contains required vars)"
          echo ""
          echo "VPS checks:"
          echo "  ‚úÖ SSH connection successful"
          echo "  ‚úÖ Docker installed"
          echo "  ‚úÖ Docker Compose installed"
          echo ""
          echo "üöÄ Ready for deployment!"
